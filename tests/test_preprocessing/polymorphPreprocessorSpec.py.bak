import os as OS
import sys as Sys

AdditionalPath = OS.path.abspath( OS.path.join( OS.path.dirname( __file__ ), '..', '..', 'biomed', 'preprocessor' ) )
if AdditionalPath not in Sys.path:
    Sys.path.append( AdditionalPath )

import unittest
from polymorph_preprocessor import PolymorphPreprocessor
from pre_processor import PreProcessor
from pandas import DataFrame

class PolymorphPreprocessorSpec( unittest.TestCase ):
    def it_is_a_PreProcessor( self ):
        MyProc = PolymorphPreprocessor.Factory.getInstance()
        self.assertTrue( isinstance( MyProc, PreProcessor ) )

    def it_ignores_everything_besides_the_text( self ):
        TestData = {
            'pmid': [ 42 ],
            'cancer_type': [ -1 ],
            'doid': [ 23 ],
            'is_cancer': [ False ],
            'text': [ "Liquid chromatography with tandem mass spectrometry method for the simultaneous determination of multiple sweet mogrosides in the fruits of Siraitia grosvenorii and its marketed sweeteners. A high-performance liquid chromatography with electrospray ionization tandem mass spectrometry method has been developed and validated for the simultaneous quantification of eight major sweet mogrosides in different batches of the fruits of Siraitia grosvenorii and its marketed sweeteners." ],
        }
        MyFrame = DataFrame( TestData, columns = [ 'pmid', 'cancer_type', 'doid', 'is_cancer', 'text' ] )
        MyProc = PolymorphPreprocessor.Factory.getInstance()
        Result = MyProc.preprocess_text_corpus( MyFrame, "" )

        self.assertEqual(
            Result[ "pmid" ][ 0 ],
            TestData[ "pmid" ][ 0 ]
        )

        self.assertEqual(
            Result[ "cancer_type" ][ 0 ],
            TestData[ "cancer_type" ][ 0 ]
        )

        self.assertEqual(
            Result[ "doid" ][ 0 ],
            TestData[ "doid" ][ 0 ]
        )

        self.assertEqual(
            Result[ "is_cancer" ][ 0 ],
            TestData[ "is_cancer" ][ 0 ]
        )

    def it_ignores_unknown_flags( self ):
        TestData = {
            'pmid': [ 42 ],
            'cancer_type': [ -1 ],
            'doid': [ 23 ],
            'is_cancer': [ False ],
            'text': [ "Liquid chromatography with tandem mass spectrometry method for the simultaneous determination of multiple sweet mogrosides in the fruits of Siraitia grosvenorii and its marketed sweeteners. A high-performance liquid chromatography with electrospray ionization tandem mass spectrometry method has been developed and validated for the simultaneous quantification of eight major sweet mogrosides in different batches of the fruits of Siraitia grosvenorii and its marketed sweeteners." ],
        }

        MyFrame = DataFrame( TestData, columns = [ 'pmid', 'cancer_type', 'doid', 'is_cancer', 'text' ] )
        MyProc = PolymorphPreprocessor.Factory.getInstance()
        Result = MyProc.preprocess_text_corpus( MyFrame, "opc" )

        self.assertEqual(
            Result[ "text" ][ 0 ],
            TestData[ "text" ][ 0 ]
        )

    def it_uses_simple_normalizer( self ):
        TestData = {
            'pmid': [ 42 ],
            'cancer_type': [ -1 ],
            'doid': [ 23 ],
            'is_cancer': [ False ],
            'text': [ "Liquid chromatography with tandem mass spectrometry method for the simultaneous determination of multiple sweet mogrosides in the fruits of Siraitia grosvenorii and its marketed sweeteners. A high-performance liquid chromatography with electrospray ionization tandem mass spectrometry method has been developed and validated for the simultaneous quantification of eight major sweet mogrosides in different batches of the fruits of Siraitia grosvenorii and its marketed sweeteners." ],
        }

        MyFrame = DataFrame( TestData, columns = [ 'pmid', 'cancer_type', 'doid', 'is_cancer', 'text' ] )
        MyProc = PolymorphPreprocessor.Factory.getInstance()
        Result = MyProc.preprocess_text_corpus( MyFrame, "l" )

        self.assertEqual(
            Result[ "text" ][ 0 ],
            TestData[ "text" ][ 0 ].lower()
        )


Suite = unittest.TestSuite()
Suite.addTests( [
    PolymorphPreprocessorSpec( "it_is_a_PreProcessor" ),
    PolymorphPreprocessorSpec( "it_ignores_everything_besides_the_text" ),
    PolymorphPreprocessorSpec( "it_ignores_unknown_flags" ),
    PolymorphPreprocessorSpec( "" )
] )

Runner = unittest.TextTestRunner()
Runner.run( Suite )
